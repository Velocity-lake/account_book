## 一、项目概述
- 名称：个人记账本——桌面端记账与账单管理应用
- 目标：覆盖收入/支出/转账/还款的记账，账户管理、账单导入/导出、图表总览、类别智能预填、信用卡与投资模块，满足个人财务记录与分析
- 范围：本需求文档不限定编程语言或框架；实现可选桌面/跨平台技术（如 Qt/Electron/Flutter/Tauri/SwiftUI 等），本地或轻量服务端存储（JSON/SQLite/本地文件）均可

## 二、用户与使用场景
- 用户：个人用户（支持多用户账本，可独立数据隔离）
- 场景：
  - 日常手动记账（直接录入）
  - 批量导入（支付宝/微信/银行/标准模板/截图识别），自动去重与类别预填
  - 账户余额联动与资产视图、信用卡账期管理
  - 月度/年度消费与收入分析，类别占比与趋势可视化

## 三、术语与数据模型（逻辑定义）
- 交易（Transaction）：`id,time,amount,category,ttype,account,to_account,from_account,note,record_time,record_source`
  - 所属类别 `ttype`：收入/支出/报销类收入/报销类支出/转账/还款
- 账户（Account）：`name,balance,type,note,bank,last4,limit,status,bill_day,repay_day,repay_offset`
- 分类体系：按场景（收入/支出）维护消费类别集合与关键词规则（用于预填）
- 偏好设置（Prefs）：菜单布局、时间格式、可见列、用户管理开关、仪表板布局与列宽等
- 投资账本（独立）：`transactions, accounts, valuations`，包含买入/卖出/估值与 ROI/XIRR

## 四、功能需求
### 1) 手动记账（Record）
- 场景切换：支出/收入/转账
- 类别选择：网格展示，左键选中；右键菜单（进入该类别清单、重命名、删除）；双击打开该类别账单列表
- 输入：金额（最多10位整数+2位小数，实时格式化预览）、备注占位提示、日期选择器
- 账户选择：按“账户类型→账户”分组；支持“新增账户”弹窗
- 报销勾选：所属类别自动改为报销类收入/支出
- 保存：校验→生成交易→写入→资产联动→清空表单并提示

### 2) 账单列表（Bills）
- 顶部过滤：年份、月份、所属类别、消费类别（含“未分类”）、搜索、金额运算符（>,<,=）与值、疑似重复阈值（秒）
- 表格：列管理（隐藏/显示/顺序与宽度保存）、表头排序、Shift+表头打开列筛选弹窗、双击行详情
- 底部汇总：筛选范围内收入/支出/转账合计；选中行合计
- 右键菜单：编辑/删除/批量改类（收入/支出/转账）/批量修改（账户/类别/来源）/AI 预填/导出疑似重复/一键删除疑似重复（保留最早）
- 查重判定：同金额且在阈值秒数内的时间相近交易打标“疑似重复”
- 导出：支持 CSV/XLSX（最小写出器或库），保留常见列

### 3) 账单导入（Import）
- 支持来源：支付宝/微信/浦发银行/中信银行/标准模板/其它（自动识别）
- 流程：读取文件→平台映射→补充 `record_time/record_source`→可选 AI 预填类别→默认账户提示→重复检测→写入与资产联动→结果统计与重复清单导出
- 覆盖导入：覆盖现有账单并重算余额；保留 AI 预填与重复导出
- 标准模板下载：生成示例 XLSX 模板

### 4) 智能导入（截图）
- 入口：智能导入（截图）面板
- 识别适配：抽象 OCR 适配层，按 tokens/文本规则推断平台/类别/金额/日期/账户；失败导出 CSV
- 去重：批次内与历史记录重复键匹配时跳过并记录

### 5) 账户管理（Accounts）
- 分组显示：按“账户类型”分组（现金/信用卡/投资理财/借款/自定义）
- 编辑模式：双击单元格编辑名称/余额/备注；重命名可选择是否同步账单历史
- 冻结资产：开启后资产不随账单变化
- 导入/导出：支持 CSV/XLSX，自动映射常见列名；“全量覆盖模式”可移除未出现账户
- 模板下载：生成标准账户模板

### 6) 信用卡管理（Credit Cards）
- 列：银行/卡名/后四位/额度/账单日/还款日/偏移/今日账期天数/状态/备注
- 过滤与排序：按银行、状态、关键词；列管理保存偏好
- 编辑/删除：右键菜单编辑卡片详情或批量删除
- 账期计算：根据账单日/还款日/偏移计算“距离本期还款日的天数”

### 7) 首页总览（Dashboard）
- KPI：总收入/总支出/净现金流/期末总资产/资产变动
- 图表：
  - 柱状图（收入/支出，按日/月/年）可点击跳转到账单列表
  - 现金流趋势图，可点击查看明细并跳转列表
  - 类别占比饼图（收入/支出），可点击某类别打开账单列表；支持“大图”弹窗
- 账户余额与本期最近记录列表；右侧日度/月度/年度模块含日历/月份网格与明细
- 列管理与宽度保存：仪表板明细列表支持列显示配置并持久化

### 8) 软件设置（Settings）
- 菜单布局：经典/精简（影响侧栏按钮）
- 时间格式：账单列表时间列显示方式（日期或日期+时分秒）
- 用户账户管理：启用后允许登录/创建用户，加载各自账本文件；支持从单用户迁移
- 数据工具：导入/导出/智能导入/模板/备份/刷新
- 类别预填规则：按关键词→类别规则管理（新增/删除/重置）

### 9) 使用说明（Help）
- 动态渲染帮助文档，左侧目录树、右侧内容与查找（Ctrl+F）

### 10) 投资理财模块（Investments）
- 独立账本文件；账户列表、估值、持有统计（累计买入/卖出/当前市值/盈亏/ROI/XIRR/持有天数）
- 投资账单列表（买入/卖出）：过滤、导入/导出、新增/编辑、批量修改
- 估值设置与快捷日历对话框

## 五、界面导航与交互规范
- 侧栏导航：Dashboard/Bills/Record/Invest/Accounts/Credit/Settings/Help/导入工具/导出/模板/备份/刷新/（启用用户管理时）登录
- 通用交互：
  - 表头左键排序、Shift+左键打开列筛选、表头右键列操作
  - 列显示管理与偏好保存
  - 列表右键菜单含批量操作与 AI 预填
  - 双击行查看详情；Ctrl+A 全选；Delete 删除选中；Shift+滚轮横向滚动

## 六、业务规则
- 资产联动：
  - 收入/报销类收入：目标账户余额 + 金额
  - 支出/报销类支出：目标账户余额 - 金额
  - 转账：`from_account` 减、`to_account` 加
  - 还款：目标账户 + 金额、转出账户 - 金额
- 冻结资产：开启后不进行余额联动
- 去重策略：金额相同且时间在设定秒阈内标记“疑似重复”；导入时采用签名（时间到秒+绝对金额+备注）防重复
- 类别预填：关键词规则优先；其次按内置关键字启发式（餐饮/交通/娱乐/医疗等）
- 平台导入映射：支持多列名兼容、金额符号与 Excel 序列日期解析
- 投资统计：盈亏=当前市值+累计卖出-累计买入；ROI=盈亏/累计买入；XIRR 按现金流序列计算

## 七、数据存储与备份（抽象）
- 本地存储：账本与偏好可存储为 JSON 或 SQLite；用户索引与多用户独立账本路径
- 备份策略：手动备份生成时间戳文件；重操作（覆盖导入/查重删除）前触发备份
- 多用户：`users/<uid>/ledger` 独立，创建/删除用户仅更新索引，不强制删除用户目录

## 八、非功能需求
- 性能：中小规模账单（万级以内）流畅；图表与筛选即时
- 可用性：全部操作本地；异常弹窗提示；关键操作前备份
- 兼容性：Windows/macOS/Linux
- 安全与隐私：
  - 本地密码散列（PBKDF2-SHA256 或等效算法）仅基础保护
  - 不上传数据；外部 OCR/API 通过适配层安全接入，不存储真实密钥

## 九、错误处理与边界案例
- 导入失败：缺列/金额不可解析/时间不可解析/账户不存在等统一错误信息与示例
- 账户删除/重命名：删除不清理账单引用；重命名可选择同步历史账单
- 信用卡账期：账单日/还款日越界纠偏与偏移优先
- 时间解析：支持 ISO/常见格式/Excel 序列日期

## 十、验收标准与测试要点
- 记账保存：合法输入保存后账单新增，账户余额按规则联动；报销勾选影响所属类别
- 导入：多来源导入正确，重复统计与导出文件生成；未指定账户时提示默认账户选择
- 账单列表：排序/筛选/列管理生效；“疑似重复”按秒阈标识；批量修改正确联动余额
- Dashboard：KPI 与柱/线/饼图与期间切换一致，点击跳转到账单列表筛选视图
- 信用卡：过滤/排序/列管理偏好保存；账期天数计算正确
- 投资：新增/编辑/导入导出；估值后 ROI/XIRR/盈亏更新

## 十一、技术实现建议（非约束）
- UI 技术：Qt/Electron/Flutter/Tauri/SwiftUI/GTK 等任意合适方案
- 数据层：本地 JSON/SQLite；提供抽象存储接口以便替换
- 打包发布：可选 PyInstaller/Electron-builder/Flutter打包/Swift打包等
- OCR/AI：通过适配层接入第三方 OCR/分类模型；密钥走环境变量/安全存储

## 十二、实现参考（当前仓库，不构成约束）
- 资产联动规则参考 storage.py:337-364
- 查重与列管理参考 ui_bill_list.py:239-268, 585-597, 1424-1452
- Dashboard 指标与图表交互参考 ui_dashboard.py:400-913
- 投资统计与 XIRR 参考 ui_investments.py:79-151, 383-454；utils.py:76-135

## 十三、未来扩展
- OCR/AI：接入真实 OCR 与模型，提升截图识别与类别预填效果
- 多语言与主题：中文/英文切换，深色主题
- 规则引擎：更丰富自动分类、预算与提醒
- 同步与共享：增设云同步或家庭共享（可选）

说明：本需求文档为语言与技术栈无约束版本；以上“实现参考”仅用于理解现有代码行为，不限定后续实现技术路线。