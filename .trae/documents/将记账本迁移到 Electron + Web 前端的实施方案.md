## 产品目标
- 以 Electron + HTML/CSS/JavaScript 重构现有 `tkinter` 应用，保留全部业务能力并显著提升 UI/交互体验。
- 数据仍采用本地 JSON 账本，兼容现有结构，确保原数据可直接迁移。
- 核心功能覆盖：账单记录与列表、账户管理、信用卡管理、导入导出、仪表盘、用户账本与偏好设置、帮助文档与备份。

## 核心页面与路由
- 侧栏菜单及页面：
  - 首页总览（Dashboard）：收入/支出柱状、现金流趋势、类别占比饼图、账户余额与最近记录（参考 `ui_main.py:49-60`, `ui_dashboard.py:24-183`）。
  - 账单列表（Bills）：筛选/排序/批量操作/列管理/查重与导出（参考 `ui_bill_list.py:21-188, 312-455`）。
  - 记录账单（Record）：支出/收入/转账、类别网格、分组账户、日期选择、报销标记（参考 `ui_record_page.py:32-140, 535-601`）。
  - 账户管理（Accounts）：分组树视图、新增/编辑/删除、模板与导入导出、冻结资产（参考 `ui_account_manager.py:16-87, 213-350`）。
  - 信用卡管理（Credit Cards）：筛选、排序、列管理、账期天数计算、编辑与删除（参考 `ui_credit_cards.py:15-48, 58-159, 182-219`）。
  - 软件设置（Settings）：菜单布局、时间格式、用户管理启用、消费类别预填规则维护（参考 `ui_settings.py:23-66, 119-164, 170-213`）。
  - 导入工具（Import）：支付宝/微信/浦发/中信/标准模板/其它导入，统计与去重、AI预填（参考 `ui_main.py:157-175, 264-365, 179-263`）。
  - 使用说明（Help）：目录与内容渲染、查找对话框（参考 `ui_help.py:13-44, 105-130`, `help_content.py:1-242`）。
  - 投资理财（Investments）：投资账本基础页面加载与失败兜底（参考 `ui_main.py:735-742`，投资账本结构见 `storage.py:127-162`）。

## 数据模型与存储
- 账本文件与目录：
  - 应用数据目录：`data/ledger.json`、`data/backups/`、`data/users/`；投资账本：`data/invest_ledger.json`（参考 `storage.py:8-18`）。
  - 多用户账本：`data/users/<user_id>/ledger.json` 与 `invest_ledger.json`（参考 `storage.py:71-85, 222-265`）。
- 账户 `Account` 字段：`name`、`balance`、`type`、`note`、`bank`、`last4`、`limit`、`status`、`bill_day`、`repay_day`、`repay_offset`（参考 `models.py:13-28`）。
- 交易 `Transaction` 字段：`id`、`time`、`amount`、`category`、`ttype`、`account`、`to_account`、`from_account`、`note`（参考 `models.py:30-53`）。
- 偏好项 `prefs`：菜单布局、账单列表列显示与时间格式、冻结资产、信用卡列表列显示、仪表盘右侧分隔位置（参考 `storage.py:33-69, 101-125, 141-158, 1041-1061`）。
- 类别与规则：`categories`、`category_rules`、`record_sources`（参考 `storage.py:33-69, 365-421, 422-432`）。

## 业务规则（必须保持一致）
- 账户余额联动：新增/编辑/删除交易需同步账户余额，按 `ttype` 不同计算（收入/支出/转账/还款）（参考 `storage.py:337-364`）。
- 去重规则：以签名 `time(到秒) + abs(amount) + note` 识别重复（参考 `utils.py:54-59`）；账单列表“疑似重复”判定基于相同金额且时间差在阈值内（默认 10 秒）（参考 `ui_bill_list.py:239-268, 247-258`）。
- 导入覆盖模式：允许“导入并覆盖原有账单”，重算账户余额并导出重复记录（参考 `ui_bill_list.py:725-844`）。
- 类别预填（AI）：基于关键词规则与若干内置词典进行类别推断；支持批量预填与导入时预填（参考 `ui_bill_list.py:1189-1230, 1149-1187`, `ui_main.py:179-207, 193-207`）。
- 用户账本切换与迁移：登录/创建用户、选择是否迁移单用户数据到新用户账本（参考 `ui_main.py:638-734`）。
- 冻结资产：冻结时账户余额不随交易变化（参考 `storage.py:338-346`, `ui_account_manager.py:92-99`）。

## 导入与导出
- 导入来源：
  - 支付宝（CSV/XLSX）：兼容多列名、跳过“不计收支”、提取类别/商品/对方/支付方式（参考 `importers.py:211-261`）。
  - 微信（CSV/XLSX）：校验必填列、解析时间/金额、生成备注，支付方式匹配账户（参考 `importers.py:157-209`）。
  - 浦发银行（CSV/XLSX/自由列）：时间多格式/Excel 序列日期、金额正负推断收支、账户命名约定（参考 `importers.py:263-355`）。
  - 中信银行（CSV/XLSX/自由列）：日期/时间标准化、收入/支出金额两列合并、摘要与对方生成备注（参考 `importers.py:357-454`）。
  - 标准模板（CSV/XLSX）：字段完整校验、Excel 日期序列兼容、账户合法性校验（参考 `importers.py:74-134`）。
  - 其它导入：自动平台识别并映射；失败弹窗与错误信息复制（参考 `importers.py:456-510`, `ui_main.py:283-365, 747-767`）。
- 导出：
  - 账单导出 CSV/XLSX，列顺序与格式与当前列表一致（参考 `ui_main.py:366-406`, `ui_bill_list.py:1424-1452`）。
  - 疑似重复导出 XLSX（参考 `ui_bill_list.py:1453-1486`）。
  - 模板下载与账户导出/模板下载（参考 `ui_main.py:411-428`, `ui_account_manager.py:229-267`）。
- 备份：手动备份当前账本到 `data/backups` 并返回路径提示（参考 `storage.py:199-220`, `ui_main.py:407-413`）。

## 智能图片导入
- 从图片文件名/文本片段粗略识别金额、日期、平台、类别与账户；批次内与历史记录去重；导出失败清单 CSV（参考 `import_ai.py:72-121`）。
- 未来可替换 `ocr_adapter` 为真实 OCR；当前实现基于文件名分词（参考 `ocr_adapter.py:3-9`）。

## 账户与信用卡模块
- 账户管理：
  - 分组统计净资产/总资产/总负债；编辑模式下单元格编辑与账单同步重命名（参考 `ui_account_manager.py:48-87, 118-203`）。
  - 导入账户：容错列映射、全量覆盖模式、类型动态扩展、校验余额数值（参考 `ui_account_manager.py:268-350`）。
- 信用卡：
  - 账期天数计算：根据账单日、还款日、偏移计算下个还款日与剩余天数（参考 `ui_credit_cards.py:182-219`）。
  - 编辑字段与筛选/排序/列管理（参考 `ui_credit_cards.py:126-181, 115-124, 160-181`）。

## 仪表盘与分析
- 期间切换：日度/月份/年份，期间下拉与上一期/本期/下一期；下方右侧模块随模式变化（参考 `ui_dashboard.py:24-83, 266-277, 1014-1033`）。
- 指标与可视化：总收入/总支出/净现金流/期末总资产/资产变动（参考 `ui_dashboard.py:419-426`）。
- 交互：
  - 柱状图点击联动账单列表（参考 `ui_dashboard.py:559-589`）。
  - 趋势图点击或近点打开对应期间账单列表（参考 `ui_dashboard.py:744-793`）。
  - 饼图点击按场景+类别打开账单列表；标题点击打开大图（参考 `ui_dashboard.py:891-913, 914-921`）。

## 交互与快捷键
- 列表表头排序、列筛选弹窗、列显隐与宽度保存、Shift+滚轮横向滚动、Ctrl+A 全选、Delete 删除选中、右键菜单批量操作（参考 `ui_bill_list.py:115-158, 183-189, 599-630, 146-162` 与 `ui_dashboard.py:1432-1581`）。
- 记录页键盘面板：`⌫/再记/保存`、金额输入自动格式化与预览，日期日历弹窗（参考 `ui_record_page.py:128-140, 507-516, 331-389`）。
- 帮助页文本查找 `Ctrl+F`（参考 `ui_help.py:105-130`）。

## 用户账本与偏好
- 登录/创建用户、密码可选（PBKDF2），切换账本路径并可迁移单用户数据；跳过登录回到单用户（参考 `ui_main.py:638-734`, `utils.py:61-75`）。
- 偏好设置：菜单布局 `classic/compact`、账单时间格式 `full/date`、账单/仪表盘/信用卡列显隐与宽度、冻结资产持久化（参考 `storage.py:53-69, 117-125`, `ui_settings.py:119-164`）。

## 非功能需求
- 安全：
  - 本地 API 仅监听 `127.0.0.1`，需令牌校验；前端启用 `contextIsolation`，禁用 `nodeIntegration`；通过 `preload` 暴露受限接口。
  - 文件访问与导入路径选择需走主进程 `dialog`；避免任意路径写入。
- 性能与体积：
  - 列表渲染与排序在 1–5 万行需平滑，考虑虚拟滚动；图表按需渲染与节流。
  - 打包体积控制，开启 `asar`，资源懒加载。
- 日志与错误：统一错误提示弹窗与复制功能；导入/导出失败清单生成与提示（参考 `ui_bill_list.py:1602-1622`、`import_ai.py:121-132`）。
- 数据目录：
  - 默认迁移到 `app.getPath('userData')`，首次启动检测并从现有 `data/` 迁移，保留备份（参考 `storage.py:199-220`）。

## Electron 架构建议
- 前端：
  - UI 使用 HTML/CSS/JS（可接入组件库与图表库）；路由与状态管理自行选择（原生或框架）。
  - 表格支持排序、筛选、列管理与虚拟滚动；图表支持悬停提示与点击联动。
- 后端：
  - 以 FastAPI/Flask 暴露本地 REST API，封装 `storage.py`、`importers.py`、`import_ai.py` 的能力。
  - Electron 主进程通过 `child_process.spawn('python', ['api_server.py'])` 启动后端；传递数据目录与令牌。
- IPC 与安全：
  - `preload.js` 注入受限的 `fetch` 封装与文件对话框调用；所有文件选择/保存走主进程。

## 交付内容
- 完整的页面与交互实现，覆盖上文全部功能与业务规则。
- 本地 API 层与进程管理脚本，数据目录迁移与备份策略。
- 打包配置（Windows 安装包/免安装版）、应用签名与基础更新方案（可选）。
- 迁移说明：原 `data/` 目录兼容与迁移、已存在用户账本保留、失败清单示例。

## 兼容性与一致性检查点
- 交易类型与余额联动一致；查重/疑似重复算法一致；导入映射与错误统计一致；偏好项落盘与列显隐行为一致；账户/信用卡字段与计算一致。
- 所有列表的右键菜单与快捷键一致；帮助页目录/查找一致；用户账本流程与提示一致。

以上需求可直接用于新任务的实施验收与测试用例设计；实现时应逐项对照相应源码位置进行一致性校验（示例引用见各段落的 `file_path:line`）。