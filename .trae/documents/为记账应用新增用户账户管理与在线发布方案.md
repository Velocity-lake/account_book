## 当前状态与目标
- 当前为桌面 `tkinter` 应用，入口 `app.py`，数据存于本地 JSON（`storage.py` 的 `load_state()/save_state()`）。
- 目标：支持“注册/登录/注销/修改密码/找回密码”，实现多用户隔离与云端同步，准备在线发布。

## 方案选型（推荐）
- 保留桌面客户端，新增一个轻量后端认证与数据同步服务（FastAPI + SQLite/PostgreSQL）。
- 客户端在启动时显示登录/注册界面；登录后加载该用户的数据（云端为主，离线可用本地缓存）。
- 好处：最少改动现有 UI/存储逻辑；可平滑迁移到线上；支持离线使用。

## 后端设计
- 技术栈：FastAPI、SQLAlchemy、JWT（PyJWT）、密码哈希（bcrypt/argon2）。
- 数据模型：`User(id, email, password_hash, created_at)`；`Ledger(user_id, blob/json, updated_at)` 或按表拆分（accounts/transactions/categories）。
- API：
  1. `POST /auth/register`（邮箱+密码、强密码策略）
  2. `POST /auth/login`（返回 JWT 访问令牌）
  3. `GET /users/me`（验证登录状态）
  4. `GET/PUT /ledger`（获取/更新用户的账本数据）
  5. 可选：`POST /auth/forgot`（邮件找回）、`POST /auth/logout`（令牌黑名单/短有效期）
- 安全：强密码、密码哈希不可逆、JWT 短时效+刷新、速率限制、TLS。

## 客户端改造（tkinter）
- 启动改造：在 `app.py` 的 `main()` 前弹出“登录/注册”窗口，成功后进入 `MainApp`（`ui_main.py`）。
- 令牌管理：登录成功后保存 JWT（避免明文，优先系统凭据存储；次选本地加密文件）。
- 数据加载：
  - 在线：使用 JWT 调用后端 `GET /ledger`，解析为现有 `state`（兼容 `storage.default_state()` 字段）。
  - 离线缓存：每次成功 `PUT /ledger` 同步到本地 `data/<user_id>/ledger.json`；断网时回退到离线文件并提示同步状态。
- 多用户隔离：`state` 增加 `user_id` 字段；本地缓存路径区分用户。
- UI：新增“用户设置”页（查看邮箱、修改密码、退出登录）；在设置页加入“同步/冲突解决”入口。

## 数据模型与存储层适配
- `storage.py` 兼容云端：保留 JSON 读写，但增加一个适配层：
  - `load_state(user_id, prefer_cloud=True)`：优先云端，失败回退本地。
  - `save_state(user_id, sync_cloud=True)`：写本地并尝试 `PUT /ledger`。
- 迁移兼容：
  - 初次登录：如果云端账本为空、且本地存在旧文件，提示“一键迁移”并上传。
  - 字段演进：保留 `default_state()`，为缺失字段赋默认值，避免旧数据崩溃。

## 同步与冲突策略
- 简单策略：以时间戳为准，云端为权威；客户端持有 `updated_at`，提交时携带 `If-Match`（版本号）。
- 冲突：检测到版本不一致时提示用户，并支持“合并/覆盖”选项；可在后端进行三方合并或字段级合并（后续迭代）。

## 安全与合规
- 不在日志中记录邮箱/密码/令牌。
- 加密传输（HTTPS）；令牌过期刷新；最小权限控制（每个请求都绑定 `user_id`）。
- 备份：后端每日快照；客户端仍保留本地 `data/backups/`（现有 `storage.backup_state()` 继续可用）。

## 迁移与发布步骤
1. 搭建后端原型（本地 SQLite）并通过 `pytest` 覆盖注册/登录/账本接口用例。
2. 客户端新增登录窗口与令牌持久化，改造 `storage.py` 增加云端适配方法。
3. 实现在线/离线切换、首次迁移流程、冲突提示。
4. 打包客户端（现有 `start_app.bat` 支持 venv），后端部署到云（Railway/Render/Azure），域名与证书配置。
5. 验证：端到端测试（注册→登录→记账→同步→离线→恢复→换机登录）。

## 迭代与可选增强
- OAuth 登录（GitHub/Google）
- 审计日志与多设备会话管理
- 数据加密（本地缓存文件加密/字段级别加密）
- 角色/共享账本（后续支持家庭共享需加 `ledger_members`）

---
如果以上方案符合预期，我将按此计划开始：先搭建后端原型并为客户端加入登录与云端适配，再完成数据迁移与同步验证。请确认。