## 目标
- 在保持当前单用户本地使用的前提下，新增“用户账户管理”能力。
- 默认关闭；开启后支持创建/登录/切换用户，并按用户隔离数据。
- 采用“特性开关 + 无损迁移”方案，随时可关闭并回到单用户模式，数据不丢失。

## 架构策略
- 特性开关：在状态中新增 `prefs.user_management_enabled`（建议写入 `storage.py` 的默认状态构造处，约 `storage.py:20–55`）。
- 数据隔离：为每个用户使用独立目录 `data/users/<user_id>/ledger.json`，原始单用户文件仍保留为 `data/ledger.json`。
- 运行态：在主界面维持 `current_user_id`（不开启时为 `None`），所有读写通过“按用户选择的 ledger 路径”进行。

## 数据模型与存储
- 用户索引：新增一个简易用户索引（用户名、`user_id`、可选密码摘要与盐、创建时间）。索引文件位于 `data/users/index.json`。
- 密码存储：使用标准库 `hashlib.pbkdf2_hmac` + 随机盐（`secrets.token_bytes(16)`）生成 `password_hash`，避免引入第三方依赖；明文密码不落盘。
- 存储 API：
  - 在 `storage.py` 中增加路径计算函数 `get_user_ledger_path(user_id)` 与通用读写函数的“可选路径”参数，允许 `load_state/save_state/backup_state` 在用户上下文工作（保持 `data/ledger.json` 兼容）。
  - 备份仍写入 `data/backups/ledger_*.json`，当开启用户模式时按用户 ID 区分命名。

## UI 变更
- 设置页开关：在 `ui_settings.py` 添加“启用用户账户管理”的开关（约 `ui_settings.py:17–36` 的设置项区域）。
- 登录与用户管理入口：
  - 在主界面导航处（约 `ui_main.py:32–69`）根据开关显示“登录/切换用户”，进入一个简单的对话框。
  - 对话框放在现有界面文件中以减少新增文件（例如 `ui_main.py` 内部类 `LoginDialog`），包含“登录、创建用户、删除用户（仅本地）、切换”。
- 启动逻辑：`app.py` 在 `main()` 初始化阶段（参考 `app.py:15`）读取开关，决定是否弹出登录对话或直接进入单用户模式。

## 迁移与回退
- 启用时的迁移选择：
  - 选项 A：将当前 `data/ledger.json` 绑定到新建的用户（复制到 `data/users/<user_id>/ledger.json`）。
  - 选项 B：保留为“游客模式”数据，不进行绑定，仅在用户登录后切换到其数据。
- 回退（关闭开关）：
  - UI 隐藏所有用户相关入口；读写恢复为 `data/ledger.json`。
  - 用户目录与索引文件保持原样，不做删除；需要时提供“恢复为单用户”操作，将选定用户数据复制回 `data/ledger.json`。
- 无损保障：所有操作以复制为主，不覆盖原始文件；删除用户前提示并执行备份。

## 改动点（文件级）
- `storage.py`：
  - 增加 `prefs.user_management_enabled` 默认值与补齐逻辑（约 `storage.py:20–55`）。
  - 新增 `get_user_ledger_path(user_id)` 与为 `load_state/save_state/backup_state` 添加“目标路径”参数（保留现有无参数用法）。
- `ui_settings.py`：增加开关控件与持久化（约 `ui_settings.py:17–36`）。
- `ui_main.py`：
  - 新增登录/切换入口（约 `ui_main.py:32–69`）。
  - 在数据读写处通过当前用户上下文选择 ledger 路径。
  - 内置一个 `LoginDialog` 简易对话框（创建/登录/切换）。
- `app.py`：按开关决定启动流程（参考 `app.py:15` 处的 `main()`）。
- `utils.py`：增加 `make_salt()` 与 `hash_password()` 封装（标准库实现）。

## 安全与发布考虑
- 本地密码仅用于基础保护，不能防止读取硬盘文件；后续若上云，需要引入真正的服务端认证与加密存储。
- 为在线发布预留扩展点：未来可替换“本地 index.json + 目录隔离”为“服务端 REST API + 令牌会话”，UI 复用登录入口。

## 实施步骤
1. 在 `storage.py` 引入特性开关与路径重构（不改变现有 API 的默认行为）。
2. 在 `ui_settings.py` 添加开关并保存到 `prefs`。
3. 在 `ui_main.py` 增加登录入口和对话框，管理 `index.json` 与用户目录。
4. 在数据读写处接入“按用户选择的 ledger 路径”。
5. 实现“启用时从单用户迁移”与“关闭时回退到单用户”两条流程，均以复制方式保证无损。
6. 补充备份命名规则与最小化提示对话。

## 你能否确认
- 是否接受“默认关闭、随时可回退”的策略？
- 用户密码是否设为可选（默认无密码，本地弱保护）？
- 用户索引存于 `data/users/index.json` 并按目录隔离是否符合你的预期？