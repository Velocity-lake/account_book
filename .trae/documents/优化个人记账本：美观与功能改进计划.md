## 目标

* 提升视觉一致性与信息密度的可读性

* 优化常用流程（记账、筛选、查重、导入）

* 增强分析能力（预算、趋势、类别洞察）

* 提高数据可靠性与性能（大量账单时仍流畅）

## 快速视觉优化（不改变结构）

* 字体统一：页面中多处直接写死 `Microsoft YaHei`（如 `ui_dashboard.py:34`、`ui_settings.py:26`）与主题中的 `Segoe UI`（`theme.py:9-17`）不一致；改为统一从样式获取字体并移除局部硬编码。

* 颜色与间距：

  * 调整表头与状态条颜色对比度，维持可读但不过度鲜艳（账单列表底部状态条在 `ui_bill_list.py:129-155`）。

  * Canvas 背景统一为浅灰（当前为纯白 `ui_dashboard.py:104,106,123,125,139,140`），增加网格线淡色。

* Treeview 可读性：

  * 斑马条纹、悬停高亮、选中行对比度提升；保持列宽更紧凑（参考初始化 `ui_bill_list.py:115-125`）。

* 记住窗口大小/最大化：`app.py:11` 目前固定 `1400x800`；保存到 `prefs` 并在启动时恢复或默认最大化。

## 交互与易用性

* 快速记账键盘：

  * 高亮当前场景色块（已部分实现 `ui_record_page.py:411-415`），补充“上一条同类复用”按钮与“最近类别”快捷区。

  * 金额输入支持分摊（拆分多类别）并显示汇总（新增对话框从 `RecordPage.save_transaction` 挂钩，入口在键盘区）。

* 筛选与表格：

  * 表头右键已支持筛选与列管理（`ui_bill_list.py:183-189`）；新增“保存为视图”功能，把当前筛选条件命名保存到 `prefs` 并一键切换。

  * 复制单元格/整行到剪贴板；双击备注弹出编辑对话框。

* 右侧模块联动：月份/日度的右侧面板已存在（`ui_dashboard.py:1014-1032`）；新增“点击统计卡片跳转到对应筛选”统一到一个方法。

## 图表与分析

* 轴刻度与数值格式：改用 `format_amount`（`utils.py`）显示千分位与单位，替换 `ui_dashboard.py:524,707` 的裸 `int(...) / f"{v:.0f}"`。

* 柱状图/折线图对齐与滚动：

  * 共享水平滚动已实现（`ui_dashboard.py:109-114,130-134`）；在缩放时保持标签不遮挡，给顶部留白（`top_pad` 动态调整）。

* 饼图“其他”聚合已实现（`ui_dashboard.py:815-821`）；增加点击图例过滤账单列表（现已支持点击扇形 `ui_dashboard.py:891-913`，补充图例点击）。

* 日历视图：现有月历（`ui_dashboard.py:1143-1193`）；支持点击日期弹出明细与新增记录入口。

* 预算功能：

  * 在 `prefs` 新增 `budgets[scene][category][month]=amount`；首页显示预算使用率、超额提醒。

## 账单列表与查重

* 查重算法：当前以“相同金额在一定秒数内”判断（`ui_bill_list.py:247-268`）。

  * 增加备注相似度（关键词或编辑距离）与账户/来源同一性，提升准确度。

  * 导出查重结果已存在（右键菜单 `ui_bill_list.py:178`）；加入“按组人工确认”模式。

* 列排序箭头状态与默认排序（`ui_bill_list.py:111-118,279-287`）保留，补充“多列排序”与“时间列切换完整/仅日期”（`prefs` 已支持 `time_format`，`ui_settings.py:33-37,153-164`）。

## 记账流程改进

* 报销流：已支持报销勾选（`ui_record_page.py:125,544-548`）；增加报销单关联与导出报销报表。

* 转账：余额联动在 `storage.py:350-356` 已正确；增加“对账状态”字段（cleared/pending），在账单列表可过滤。

* 附件：在交易中新增 `attachments: [path]` 字段；账单列表支持预览图片/PDF。

## 导入与智能识别

* 导入面板与 AI 预填：

  * 导入流水后关键词预填（`ui_main.py:193-200`）已存在，扩展规则到“场景+关键词+来源/账户+金额范围”。

  * 截图识别入口已有（侧边栏 `ui_main.py:82`、设置页 `ui_settings.py:52`）；补充失败样本导出与规则学习联动。

* 模板映射：首次导入未知格式时，弹出“字段映射向导”，并保存为自定义模板。

## 账户与资产

* 账户分类与余额：列表已在首页展示（`ui_dashboard.py:986-1006`）；增加“资产分组饼图”和“负债趋势”。

* 信用卡：当前页支持账期计算（`ui_credit_cards.py:182-200`）；补充“本期应还金额”字段与提醒（结合账单过滤）。“还款偏移”用于跨月修正已处理（同文件）。

## 性能与数据可靠性

* 聚合加速：首页多次遍历交易（如 `ui_dashboard.py:439-496,590-646,795-805`）；引入按年月索引缓存，更新时仅增量重算。

* 数据存储：当前为 JSON（`storage.py:12,86-125,193-198`）。当交易量>2万时建议切换到内置 `sqlite3`：

  * 表：`transactions`、`accounts`、`categories`、`rules`；为时间、金额、类别建索引；开启事务保证一致性。

  * 搜索：开启 FTS5 用于全文检索备注；账单列表的筛选直接查询而不是 Python 过滤。

  * 继续提供 JSON 导入导出，保证可迁移。

## 安全与备份

* 备份文件命名已含用户ID（`storage.py:199-217`）；增加“自动备份策略”和“密码保护账本”（对 `data/users/<uid>` 使用对称加密存储，留可选项）。

## 架构与代码整理

* 将绘图逻辑封装为 `ChartCanvas` 类，统一坐标与交互（提取自 `ui_dashboard.py:438-575,590-718,808-852`）。

* 把规则引擎整理到 `services/rules.py`，UI 仅调用接口；同时为导入与预填提供一处复用。

* 统一所有 UI 字体/颜色/间距从 `theme.py` 提供，页面仅声明样式名。

## 里程碑与实施顺序

1. 字体统一与主题完善、表格斑马纹、窗口几何记忆（纯 UI 快改）。
2. 账单列表视图保存、复制/编辑交互、小型查重增强。
3. 首页图表格式化与预算面板；日历点击联动。
4. 记账分摊与附件；报销与转账的对账状态。
5. 导入映射向导与规则扩展；AI 失败样本回收。
6. 性能索引缓存；如数据量较大再引入 SQLite（保留向后兼容）。

## 需要确认

* 是否需要预算与超额提醒（消息弹窗或状态条高亮）

* 是否需要账本加密与多用户登录密码

* 是否预计近期交易量会显著上升（决定是否优先上 SQLite）

