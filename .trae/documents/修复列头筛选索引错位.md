## 需求理解（含补充）

* 顶部新增“查重”按钮与“相差秒数”输入框（默认10），用于判定时间差阈值。

* 新增“疑似重复”列，满足判定规则的记录标记为“是”。

* 判定规则：同金额，交易时间绝对差不超过输入的秒数（到秒级）。

* 提供可落地处理：快速筛选、导出清单、批量删除保留一条、（可选）标记为非重复。

## 判定规则与算法

* 条件：`金额完全一致` 且 `|timeA - timeB| <= 秒数阈值`（阈值来自输入框）。

* 方法：金额分组 + 组内按时间排序 + 滑窗在阈值范围内标记为疑似重复。

* 使用 `utils.parse_datetime` 解析时间，避免显示格式影响计算。

## 界面改动

* 输入框（相差秒数）：

  * 放在顶部筛选区，“金额”控件旁边或“查重”按钮左侧；宽度约6-8字符；默认值“10”。

  * 输入限制：仅允许数字，实时清洗（参考 `ui_bill_list.py:50-56` 的金额输入清洗逻辑）。

* “查重”按钮：点击后计算并将列表过滤到“疑似重复=是”；再次点击取消筛选。

* 新增列“疑似重复”：默认显示，可参与列筛选与排序。

* 右键菜单：新增“导出疑似重复”“一键删除疑似重复（保留每组最早一条）”“（可选）标记为非重复”。

## 代码改动位置

* 列定义：在 `ui_bill_list.py:81-93` 的 `self.all_columns` 加入 `"疑似重复"`。

* 顶部控件：在 `ui_bill_list.py:57-63` 附近新增 `ttk.Entry`（`self.e_dup_secs`）与 `ttk.Button(text="查重", command=self.run_dedupe)`；为 `self.e_dup_secs` 绑定输入清洗与阈值读取方法。

* 列筛选/通过逻辑：

  * `ui_bill_list.py:1133-1239 open_filter_popup` 支持“疑似重复”取值集合（`{"是",""}`）。

  * `ui_bill_list.py:1249-1277 pass_column_filters` 增加“疑似重复”判断分支。

* 行构建：在 `ui_bill_list.py:254-395 apply_filter` 增加 `compute_suspicions(threshold_secs)` 计算，插入列值。

* 右键菜单方法：在 `ui_bill_list.py:150-165` 增加 `export_suspected()` 与 `dedupe_delete_keep_first()`，前者沿用现有导出逻辑，后者批量删除并 `backup_state()`。

## 处理方案

* 快速筛选：输入秒数（默认为10）后点击“查重”；再次点击显示全部。

* 导出：导出当前疑似重复列表到Excel，包含交易时间/金额/类别/账户/备注。

* 批量删除（保留一条）：按重复组保留最早一条，删除其余，账户余额通过 `apply_transaction_delta` 同步；操作前自动备份。

* 人工处理：配合“删除选中”“编辑”；可选实现“标记为非重复”字段以跳过后续查重。

## 数据与偏好

* 基础实现不改动账本结构；“相差秒数”不持久化或可选持久化在 `prefs.bill_list.dedupe_secs`（默认10）。

* 若启用“非重复标记”，为交易增加布尔字段 `dedupe_ignore` 并在查重时跳过。

## 验证

* 构造近时间同金额数据验证：阈值变更立刻生效；导出与批量删除统计正确；备份可回退。

## 是否同意

* 请确认以上方案（特别是“相差秒数”输入框的放置位置与默认值10）。同意后我将开始修改程序并提交具体改动。

