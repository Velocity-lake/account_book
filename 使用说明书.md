# 个人记账本 使用说明书（最全版）

## 简介
- 本软件是使用 Python `tkinter` 构建的桌面记账应用，支持账单记录、账户管理、导入/导出、备份与简单截图识别。
- 启动：在项目根目录执行 `python app.py`，入口参考 `app.py:15`。
- 数据位置：首次运行将创建 `data/ledger.json` 并生成 `data/backups/` 备份目录（`storage.py:8-13, 111-132`）。

## 快速上手
- 启动后进入主界面（标题“个人记账本”）。侧边栏为一级菜单：
  - 首页总览、账单列表、记录账单、账户管理、软件设置（经典布局下还包含数据工具入口）。
- 首次使用建议：先在“账户管理”新增账户 → 在“导入账单”导入历史账单 → 在“记录账单”日常新增支出/收入 → 在“首页总览”查看分析图表。

## 一级菜单详解

### 首页总览
- 视图切换：顶部选择“日度/月份/年份”，可用“上一期/本期/下一期”跳转（`ui_dashboard.py:32-44, 183-235, 266-309`）。
- KPI 指标：总收入、总支出、净现金流、期末总资产、资产变动（`ui_dashboard.py:46-51, 332-336`）。
- 柱状图（收入/支出）：
  - 悬停显示数值；单击某柱进入该日/月/年且按“收入/支出”过滤的账单筛选视图（`ui_dashboard.py:456-468, 469-498`）。
  - 支持水平滚动（Shift+滚轮）与共享滚动条（`ui_dashboard.py:135-137, 83-86`）。
- 现金流趋势：
  - 悬停显示当期净现金流；单击某点打开该期间的账单筛选视图（`ui_dashboard.py:621-635, 636-676`）。
- 类别饼图（收入/支出）：
  - 悬停显示金额与占比；单击某扇区打开该类别的账单筛选视图（`ui_dashboard.py:731-748, 755-777`）。
- 右侧模块：
  - 日度模式：月历（按日收入/支出缩略）+ 当月每日明细树（`ui_dashboard.py:892-966, 968-1036`）。
  - 月份模式：12个月总览网格 + 单月明细列表（`ui_dashboard.py:1037-1130`）。
- 账户余额与最近记录：本期账户净流与最近20条记录（`ui_dashboard.py:115-123, 841-868`）。
- 交互提示：整体视图支持拖拽与滚轮垂直滚动；图表标签与坐标轴刻度自适配（`ui_dashboard.py:139-156, 349-456, 499-620`）。

### 账单列表
- 筛选与检索：
  - 条件：月份、所属类别（收入/支出/报销类/转账）、消费类别、关键词搜索、金额比较（`ui_bill_list.py:24-55, 257-381`）。
  - 列头筛选：右键列头 → “筛选该列”，支持快速升/降序与清除该列筛选（`ui_bill_list.py:1101-1206`）。
- 排序与列管理：
  - 点击列头切换升/降序；默认“交易时间”降序（`ui_bill_list.py:96-106, 224-256`）。
  - 显示列管理：右键列头 → “显示列管理”，勾选可见列；支持“基础/扩展/全部”预设；可见列持久化（`ui_bill_list.py:508-539, 488-507`）。
- 选择统计：底部显示当前筛选的收入/支出/转账合计；右侧体现选中记录合计（`ui_bill_list.py:109-136, 424-452`）。
- 编辑与批量：
  - 单条：右键 → “编辑/删除”；删除时自动同步账户余额（`ui_bill_list.py:554-596`）。
  - 批量改类型：右键 → “批量改为收入/支出/转账”，自动同步账户余额（`ui_bill_list.py:911-966, 741-766`）。
  - 批量修改账户/消费类别/记账来源：右键 → 对应命令；支持“仅填充空值”（`ui_bill_list.py:767-839, 841-909, 955-1011`）。
- AI 预填消费类别：右键 → “AI预填消费类别”，基于规则自动填充（`ui_bill_list.py:1013-1051, 1053-1094`）。
- 导入/导出：
  - 标准导入：导入标准 `.xlsx` 文件到当前账本（`ui_bill_list.py:1306-1348`）。
  - 覆盖导入：导入多文件覆盖现有账单并重算账户（可选择 AI 预填与默认账户；冻结资产时不重置余额；重复项导出）（`ui_bill_list.py:625-740`）。
  - 导出：导出为 `.xlsx` 或 `.csv`（`ui_bill_list.py:1277-1305`）。
- 详情弹窗：双击行查看记录详情（`ui_bill_list.py:1246-1276`）。

### 记录账单
- 场景：支出、收入、转账；勾选“报销”将生成对应“报销类”类型（`ui_record_page.py:28-33, 360-373`）。
- 类别网格：单击选中高亮；右键类别菜单（进入该类别清单/重命名/删除）；双击类别直接打开该类别的清单（`ui_record_page.py:108-127, 241-256, 303-306`）。
- 金额与备注：金额自动格式化与合法性校验（最大10位整数+2位小数）；备注占位与焦点行为（`ui_record_page.py:329-341, 360-368, 351-359`）。
- 日期选择：弹出式日历，按钮显示“今天”或具体日期（`ui_record_page.py:172-224, 342-350`）。
- 账户选择：
  - 支/收：按“账户分类”分组选择；自动回填分类（`ui_record_page.py:60-67, 158-171, 453-472`）。
  - 转账：选择转出/转入分类与账户，保存后同步两账户余额（`ui_record_page.py:128-157, 374-391`）。
- 键盘区：包含数字与操作键，“再记”快速清空继续录入，“保存”提交（`ui_record_page.py:71-81, 307-328`）。

### 账户管理
- 分组与汇总：按类型分组显示，每组汇总金额；顶部显示净资产/总资产/总负债（`ui_account_manager.py:48-81`）。
- 编辑模式：启用后双击表格可内联编辑账户名/余额/备注；重命名可选择同步账单中的引用（`ui_account_manager.py:25-28, 100-187`）。
- 冻结资产：切换后导入覆盖时不重置余额（联动账单覆盖导入逻辑）（`ui_account_manager.py:92-99; ui_bill_list.py:680-688`）。
- 导入/导出与模板：导入账户支持“全量覆盖模式”（未出现在文件中的账户将被移除）；导出为 `.xlsx/.csv`；下载标准模板（`ui_account_manager.py:214-253, 254-336`）。

### 软件设置
- 菜单布局：切换“经典布局/精简布局”，偏好持久化（`ui_settings.py:22-26, 84-93; ui_main.py:63-71`）。
- 数据工具入口：在设置页可直接打开“导入账单/导出账单/智能导入（截图）”（`ui_settings.py:27-32`）。
- 模板与备份：下载标准模板、备份数据（`ui_settings.py:33-37`）。
- 系统与工具：刷新数据（`ui_settings.py:38-41`）。
- 关键词规则（AI 预填）：添加/删除/重置规则；导入与批处理时按规则填充类别（`ui_settings.py:42-83; ui_main.py:398-439; ui_bill_list.py:1053-1094`）。

## 数据工具（经典布局侧边栏）
- 导入账单：选择“支付宝/微信/标准模版/其它导入”，支持默认账户选择与 AI 预填，重复项导出（`ui_main.py:115-131, 132-219, 220-278`）。
- 智能导入（截图）：选择订单截图图片集，自动识别记录、检测重复并合并，生成失败清单（`ui_main.py:440-487`）。
- 导出账单：导出为 `.xlsx/.csv`（`ui_main.py:279-319`）。
- 下载标准模板：生成含标准列头的空 `.xlsx`（`ui_main.py:324-341`）。
- 备份数据：创建备份文件并提示路径（`ui_main.py:320-323`）。
- 刷新数据：重新载入并刷新“账单列表/账户管理”（`ui_main.py:99-103`）。

## 常见工作流
- 初次建账：
  1) 在“账户管理”新增常用账户与类型；
  2) 在“导入账单”导入历史平台账单或标准模版；
  3) 选择默认账户（如有空缺）并启用 AI 预填；
  4) 查看导入结果与重复导出路径；
  5) 在“首页总览”和“账单列表”核对与分析（`ui_main.py:220-278, 135-219`）。
- 日常记账：使用“记录账单”快捷键盘与类别网格快速录入；转账按两账户设置保存（`ui_record_page.py:71-81, 360-413`）。
- 分析查看：从“首页总览”点击图元进入明细列表，或在“账单列表”使用筛选/排序/列管理（`ui_dashboard.py:469-498, 636-676, 755-777; ui_bill_list.py:24-55, 224-256, 1101-1206`）。
- 账户维护：在“账户管理”开启编辑模式进行内联编辑；需要时导入全量覆盖更新账户（`ui_account_manager.py:88-99, 100-187, 254-336`）。
- 规则优化：在“软件设置”维护关键词规则以提升 AI 预填准确度（`ui_settings.py:42-83`）。

## 技巧与注意事项
- 重复检测：导入时按交易签名去重；重复条目导出到 `duplicates_YYYYMM_HHMM.xlsx` 以便核对（生成位置在项目根目录，`ui_main.py:207-217; ui_bill_list.py:727-735`）。
- 冻结资产：开启后覆盖导入不重置余额；关闭后将按新账单重算账户（`ui_bill_list.py:680-688; ui_account_manager.py:92-99`）。
- 偏好持久化：如显示列与菜单布局将写入状态文件（`ui_bill_list.py:488-507; ui_settings.py:84-93`）。
- 交互：图表支持 Shift+滚轮水平滚动；主视图支持拖拽与滚轮垂直滚动（`ui_dashboard.py:135-137, 139-156`）。
- 错误处理：导入/导出失败将弹窗提示具体错误；覆盖导入前自动备份，备份路径在弹窗中显示（`ui_bill_list.py:632-639, 736-740; ui_account_manager.py:332-336`）。

## 文件与路径
- 账本：`data/ledger.json`（当前活跃账本路径可通过 `storage.get_current_ledger_path()` 获得，`storage.py:64-66`）。
- 备份：`data/backups/ledger_[userId]_YYYYMMDD_HHMMSS.json`（`storage.py:111-132`）。
- 说明书：项目根目录 `使用说明书.md`（本文件）。

## 安全与隐私
- 本应用默认不集成外部服务密钥；如需接入 OCR/API，请通过环境变量或本地未提交文件管理密钥，勿提交真实密钥到仓库（参考 `README.md` 配置说明）。

## 附录：代码参考（进阶）
- 入口与主题：`app.py:5-15`
- 主界面与菜单：`ui_main.py:30-71`
- 首页总览图表与模块：`ui_dashboard.py:19-138, 349-456, 499-620, 892-1130`
- 账单列表筛选/排序/列管理/批量：`ui_bill_list.py:21-167, 224-256, 767-1011`
- 记录账单页面与保存逻辑：`ui_record_page.py:10-24, 360-413`
- 账户管理：`ui_account_manager.py:16-47, 88-99, 100-187, 254-336`
- 设置页与规则：`ui_settings.py:17-83`
- 存储层与账户/交易联动：`storage.py:8-16, 231-276, 277-332`